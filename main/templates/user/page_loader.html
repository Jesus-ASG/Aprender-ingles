{% extends 'main_template.html' %}
{% load static %}

{% block title %} {{ story.title1 }} {% endblock %}

{% block page-styles %}
<link rel="stylesheet" href="{% static 'css/user/story_render.css' %}">
<link rel="stylesheet" href="{% static 'css/user/story_info.css' %}">
<link rel="stylesheet" href="{% static 'css/utils/arrows.css' %}">
<link rel="stylesheet" href="{% static 'css/user/profile.css' %}">

<style>
  .img-t-1 {
    width: 33%;
    height: auto;
    align-items: center;
    margin: 2%;
    float: left;
  }

  .img-t-1 img {
    margin: auto;
    width: 100%;
    display: inline-block;
  }

  .change-img {
    width: 20%;
    min-width: 40px;
    min-height: 40px;
    background-color: #f89a16;
    border-radius: 100%;
    float: left;
    position: relative;
    margin-top: -50px;
    margin-left: 2%;
    transition: all 0.2s ease-in-out;
  }

  .change-img:hover {
    transform: scale(1.1);
  }

  .video-frame {
    width: 100%;
    height: 500px;
  }

  @media only screen and (max-width: 620px) {
    .video-frame {
      height: 300px;
    }
  }

  @media only screen and (max-width: 300px) {
    .video-frame {
      height: 250px;
    }
  }
</style>
{% endblock %}

{% block content %}

<div class="container main-content">
  <div class="row mt-3">
    <div class="col-2 back-btn-container">
      {% if prev_page is None %}
      <a href="{% url 'story_info' route=story.route %}" id="back_page_btn">
        <span><i class="fa-solid fa-arrow-left"></i></span>
      </a>
      {% else %}
      <a href="{% url 'story_content' route=story.route page_number=prev_page %}" id="back_page_btn">
        <span><i class="fa-solid fa-arrow-left"></i></span>
      </a>
      {% endif %}
    </div>
    <div class="col-8 text-center text-muted fs-4">{{ page_number }}/{{ total_pages }}</div>
    <div class="col-2 next-btn-container">
      {% if next_page is not None %}
      <a href="{% url 'story_content' route=story.route page_number=next_page %}" id="next_page_btn">
        <span><i class="fa-solid fa-arrow-right"></i></span>
      </a>
      {% endif %}
    </div>
  </div>
</div>
<!-- Content area -->
<div class="container main-content">
  <div class="row mt-3">
    <div class="col-12 page-title-container">
      <h1 class="fs-1 text-center">
        <div id="subtitle"></div>
      </h1>
    </div>
  </div>
  <div class="row my-3">
    <div class="col-12">
      {% if current_page.page_type == 1 %}
      {% include 'user/render_page/template_1.html' %}
      {% elif current_page.page_type == 2 %}
      {% include 'user/render_page/template_2.html' %}
      {% endif %}
    </div>
  </div>
</div>
<!-- Ends of content area -->
<div class="container main-content">
  <div class="row mt-3">
    <div class="col-12">
      <h2 class="fs-3 text-center mt-3" id="answer_questions_message"></h2>
      <hr style="color: var(--f-orange); height: 5px;">
    </div>
    <div class="col-12"><span id="exercises_area"></span></div>
  </div>
</div>

<div class="row my-3">
  <div class="col-12 mb-3 text-center">
    <!-- 
      <button type="button" class="btn btnr-f-orange fs-5" title="Regresar">
        <span><i class="fa-solid fa-book"></i></span>
      </button>
    -->
    <button id="btn_send_answers" type="button" class="btn btnr-f-orange fs-5" title="Enviar respuestas">
      <span><i class="fa-solid fa-check"></i></span>
    </button>
  </div>
</div>

<!-- Statistics -->
<div class="container main-content d-none" id="results">
  {% include 'utils/story_statistics.html' %}
</div>
{% if next_page is None %}
<input id="next_page_input" type="text" value="{% url 'story_info' route=story.route %}" hidden>
{% else %}
<input id="next_page_input" type="text" value="{% url 'story_content' route=story.route page_number=next_page %}"
  hidden>
{% endif %}

{% endblock %}

{% block page-scripts %}
<script>
  const URL_ANSWER_PAGE = '{% url "story_content" route=story.route page_number=page_number %}';
  const URL_NEXT_PAGE = document.getElementById("next_page_input").value;
  const URL_REQUEST_EXERCISE_ANSWER = '{% url "request_exercise_answer" %}';
  let db_page_number = parseInt('{{ page_number }}');
  let db_total_pages = parseInt('{{ total_pages }}');

  const LAST_PAGE = (db_page_number == db_total_pages) ? true : false;

  let db_story_id = '{{ story.id }}';
  let db_page_id = '{{ current_page.id }}';

  // Database elements
  let db_subtitle = {};
  let db_images = [];
  let db_videos = [];
  let db_texts = [];
  let db_dialogues = [];
  let db_repeat_phrases = [];
  let db_spellchecks = [];

  let db_answers = {};
  let db_score = {};

  // Save answers to send and evaluate it
  let user_answers = [];

  try {
    db_subtitle.subtitle1 = '{{ current_page.subtitle1 }}';
  } catch (e) { }
  try {
    db_subtitle.subtitle2 = '{{ current_page.subtitle2 }}';
  } catch (e) { }
  try {
    db_images = JSON.parse('{{ images_json |safe }}');
  } catch (e) { }
  try {
    db_videos = JSON.parse('{{ videos |safe }}');
  } catch (e) { }
  try {
    db_texts = JSON.parse('{{ texts |safe |escapejs }}');
  } catch (e) { }
  try {
    db_dialogues = JSON.parse('{{ dialogues |safe |escapejs }}');
  } catch (e) { }
  try {
    db_repeat_phrases = JSON.parse('{{ repeat_phrases |safe |escapejs }}');
  } catch (e) { }
  try {
    db_spellchecks = JSON.parse('{{ spellchecks |safe |escapejs  }}');
  } catch (e) { }

  try {
    db_answers = JSON.parse('{{ answers |safe |escapejs }}');
  } catch (e) { }

  try {
    db_score = JSON.parse('{{ score |safe |escapejs }}');
  } catch (e) { }
</script>

<script src="{% static 'js/sort_collections.js' %}"></script>
<script src="{% static 'js/user/functions_for_render_elements.js' %}"></script>
<script>
  let total_translations = { "start": 0, "end": 0 };

  setSubtitle(total_translations);

  setAnswerQuestionsMessage(total_translations);
  // Sort collections
  sortCollections();
  // Render elements
  for (let element of collections_sorted) {
    switch (element.type) {
      case "image":
        break;
      case "video":
        renderVideo(element);
        break;
      case "text":
        renderText(element, total_translations);
        break;
      case "dialogue":
        renderDialogue(element, total_translations);
        break;
      case "repeat_phrase":
        renderRepeatPhrase(element, total_translations);
        break;
      case "spellcheck":
        renderSpellcheck(element, total_translations);
        break;
    }
  }

  setFunctionality(total_translations);

  function setSubtitle(total_translations) {

    let sub1 = db_subtitle.subtitle1;
    let sub2 = db_subtitle.subtitle2;
    if (db_subtitle.subtitle1 == '' || db_subtitle.subtitle2 == '') {
      sub1 = "Page " + db_page_number;
      sub2 = "Página " + db_page_number;
    }
    let html_subtitle = createFlipHTML(sub1, sub2, total_translations);
    document.getElementById("subtitle").outerHTML = html_subtitle;
  }

  function setAnswerQuestionsMessage(total_translations) {
    let text1 = "Make your best effort to answer!";
    let text2 = "¡Has tu mejor esfuerzo para contestar!";
    document.getElementById("answer_questions_message").innerHTML = createFlipHTML(text1, text2, total_translations);
  }
</script>
<script src="{% static 'js/user/answer_exercises.js' %}"></script>
<script>
  // Buttons for save answers

  let btn_send_answers = document.getElementById('btn_send_answers')
  if (btn_send_answers) btn_send_answers.addEventListener('click', (e) => { saveAnswers(true, true) });

  let back_page_btn = document.getElementById('back_page_btn')
  if (back_page_btn) back_page_btn.addEventListener('click', (e) => { saveAnswers(false, false) });

  let next_page_btn = document.getElementById('next_page_btn')
  if (next_page_btn) next_page_btn.addEventListener('click', (e) => { saveAnswers(false, false) });


  setVolumeFunctionality();
</script>
{% endblock %}