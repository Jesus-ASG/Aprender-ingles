{% extends 'main_template.html' %}
{% load static %}

{% block title %} {{ story.title1 }} {% endblock %}

{% block page-styles %}
<link rel="stylesheet" href="{% static 'css/user/story_render.css' %}">
<link rel="stylesheet" href="{% static 'css/user/story_info.css' %}">
<link rel="stylesheet" href="{% static 'css/utils/arrows.css' %}">
<link rel="stylesheet" href="{% static 'css/user/profile.css' %}">
<link rel="stylesheet" href="{% static 'css/editor-display_template_1.css' %}">

<style>
  /* Styles for template 2*/
  .video-frame {
    width: 100%;
    height: 500px;
  }

  @media only screen and (max-width: 620px) {
    .video-frame {
      height: 300px;
    }
  }

  @media only screen and (max-width: 300px) {
    .video-frame {
      height: 250px;
    }
  }

  /* End of styles for template 2 */

  /* General styles */
  .control-buttons {
    width: 100%;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
  }

  .exit-btn,
  .save-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background-color: var(--f-orange);
    width: 45px;
    height: 45px;
    color: #fff;
    margin: 0.5rem 1rem;
    transition: all 0.2s ease-in-out;
  }

  .exit-btn span,
  .save-btn span {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .exit-btn i,
  .save-btn i {
    font-size: 1.1rem;
    color: #fff;
  }

  .exit-btn:hover,
  .save-btn:hover {
    transform: scale(1.1);
    color: #fff;
  }

  /* End of general styles */
</style>
{% endblock %}

{% block content %}

<div class="container main-content">
  <div class="row mt-3">
    <div class="col-2 back-btn-container">
      {% if prev_page is None %}
      <a href="{% url 'story_info' route=story.route %}" id="back_page_btn">
        <span><i class="fa-solid fa-arrow-left"></i></span>
      </a>
      {% else %}
      <a href="{% url 'story_content' route=story.route page_number=prev_page %}" id="back_page_btn">
        <span><i class="fa-solid fa-arrow-left"></i></span>
      </a>
      {% endif %}
    </div>
    <div class="col-8 text-center text-muted fs-4">{{ page_number }}/{{ total_pages }}</div>
    <div class="col-2 next-btn-container">
      {% if next_page is not None %}
      <a href="{% url 'story_content' route=story.route page_number=next_page %}" id="next_page_btn">
        <span><i class="fa-solid fa-arrow-right"></i></span>
      </a>
      {% endif %}
    </div>
  </div>
</div>

{% if current_page.page_type == 1 %}
{% include 'page_display/page_display_template_1.html' %}
{% elif current_page.page_type == 2 %}
{% include 'page_display/page_display_template_2.html' %}
{% elif current_page.page_type == 3 %}
{% include 'page_display/page_display_template_3.html' %}
{% endif %}


<div class="control-buttons my-3">

  <!-- Exit button -->
  <div type="button" class="btn exit-btn" title="Salir" data-bs-toggle="modal" data-bs-target="#exit_modal">
    <span><i class="fa-solid fa-xmark"></i></span>
  </div>

  <div class="modal fade" id="exit_modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title  col-11 text-center">¿Desea regresar a la información de la historia?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="close"></button>
        </div>
        <div class="modal-body">
          <p class="text-center text-primary"><i class="fa-solid fa-circle-info"></i>
            Sus respuestas se guardarán para continuar más tarde.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <a href="{% url 'story_info' story.route %}" class="btn btn-danger">
            Salir</a>
        </div>
      </div>
    </div>
  </div>
  <!-- End of exit button -->

  <button id="btn_send_answers" type="button" class="btn save-btn" title="Enviar respuestas">
    <span><i class="fa-solid fa-check"></i></span>
  </button>

</div>

<!-- Statistics -->
<div class="container main-content d-none" id="results">
  {% include 'utils/story_statistics.html' %}
</div>
{% if next_page is None %}
<input id="next_page_input" type="text" value="{% url 'story_info' route=story.route %}" hidden>
{% else %}
<input id="next_page_input" type="text" value="{% url 'story_content' route=story.route page_number=next_page %}"
  hidden>
{% endif %}

{% endblock %}

{% block page-scripts %}
<script>
  const URL_ANSWER_PAGE = '{% url "story_content" route=story.route page_number=page_number %}';
  const URL_NEXT_PAGE = document.getElementById("next_page_input").value;
  const URL_REQUEST_EXERCISE_ANSWER = '{% url "request_exercise_answer" %}';

  let db_page_number = parseInt('{{ page_number }}');
  let db_total_pages = parseInt('{{ total_pages }}');
  let page_type = '{{ current_page.page_type }}';

  const LAST_PAGE = (db_page_number == db_total_pages) ? true : false;

  let db_story_id = '{{ story.id }}';
  let db_page_id = '{{ current_page.id }}';
  let default_cover = '{{ story.cover.url }}';

  // Database elements
  let db_answers = {};
  let db_score = {};

  // Save answers to send and evaluate it
  let user_answers = [];
  let page = {
    "id": 0,
    "audios": [],
    "videos": [],
    "images": [],
    "texts": [],
    "dialogues": [],
    "spellchecks": [],
    "questions": [],
    "repeat_phrases": [],
    "subtitle1": "",
    "subtitle2": "",
    "page_type": 0,
    "date_created": "",
    "time_created": "",
    "story": 0
  };
  let page_id = 0;
  try {
    page = JSON.parse('{{ json_page|escapejs }}');
  }
  catch (e) { }
  if (page.id != 0)
    page_id = page.id;


  try {
    db_answers = JSON.parse('{{ answers |safe |escapejs }}');
  } catch (e) { }

  try {
    db_score = JSON.parse('{{ score |safe |escapejs }}');
  } catch (e) { }

  let total_translations = { "start": 0, "end": 0 };
</script>

<script src="{% static 'js/sort_collections.js' %}"></script>
<script src="{% static 'js/functions_for_display_elements.js' %}"></script>
<!-- Load page content -->
<script src="{% static 'js/load_page_display.js' %}"></script>
<!---->
<script src="{% static 'js/user/answer_exercises.js' %}"></script>
<script>
  // Buttons for save answers

  let btn_send_answers = document.getElementById('btn_send_answers')
  if (btn_send_answers) btn_send_answers.addEventListener('click', (e) => { saveAnswers(true, true) });

  let back_page_btn = document.getElementById('back_page_btn')
  if (back_page_btn) back_page_btn.addEventListener('click', (e) => { saveAnswers(false, false) });

  let next_page_btn = document.getElementById('next_page_btn')
  if (next_page_btn) next_page_btn.addEventListener('click', (e) => { saveAnswers(false, false) });


  setVolumeFunctionality();
</script>
{% endblock %}